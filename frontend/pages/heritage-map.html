<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éé—åœ°å›¾ - é™•è¥¿éç‰©è´¨æ–‡åŒ–é—äº§å±•ç¤ºå¹³å°</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="shortcut icon" href="/static/common/favicon.ico">
    <link rel="stylesheet" href="/css/pages/heritage-map.css">
    <!-- ç™¾åº¦åœ°å›¾APIå¼•ç”¨ -->
    <!-- å†œå†æ—¥æœŸè½¬æ¢åº“ -->
    <script src="/js/lib/LunarSolarConverter.js" defer></script>
    <!-- æ—¥æœŸæ—¶é—´å·¥å…·æ¨¡å— -->
    <script src="/js/common/date-utils.js" defer></script>
    <!-- åŸºç¡€å·¥å…·å’Œæ•°æ® (depends on date-utils) -->
    <script src="/js/common/utils.js" defer></script>
    <!-- APIå®¢æˆ·ç«¯ Core -->
    <script src="/js/common/api.js" defer></script>
    <!-- Heritage Specific API (may be used by api-utils or others) -->
    <script src="/js/common/heritage-api.js" defer></script>
    <!-- API Utilities (depends on heritage-api, potentially api.js) -->
    <script src="/js/common/api-utils.js" defer></script>
    <!-- ç”¨æˆ·è®¤è¯è„šæœ¬ -->
    <script src="/js/common/auth.js" defer></script>
    <!-- ç»Ÿè®¡è·Ÿè¸ªè„šæœ¬ -->
    <script src="/js/common/tracker.js" defer></script>
<!-- ç™¾åº¦åœ°å›¾APIå°†é€šè¿‡ä¸‹æ–¹çš„loadBaiduMapsAPIå‡½æ•°åŠ è½½ -->    <!-- ç”¨æˆ·èµ„æ–™API -->
    <script src="/js/api/user-profile-api.js" defer></script>
    
    <link rel="stylesheet" href="/css/pages/heritage-map-overlay.css">
    <script type="text/javascript">
        // ç™¾åº¦åœ°å›¾AKé€šè¿‡åç«¯APIè·å–ï¼Œé¿å…åœ¨å‰ç«¯æš´éœ²
        window.BMAP_AUTHENTIC_KEY = null; // å°†é€šè¿‡APIè·å–

        // ç®€åŒ–çš„é”™è¯¯æ˜¾ç¤ºå‡½æ•°
        function showMapError(message) {
            const mapContainer = document.getElementById('baidu-map');
            if (mapContainer) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'map-error-overlay';
                errorDiv.innerHTML = `
                    <div class="map-error-content">
                        <h3>åœ°å›¾åŠ è½½å¤±è´¥</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()">é‡æ–°åŠ è½½</button>
                    </div>
                `;
                mapContainer.appendChild(errorDiv);
            }
            // Update API status for debug panel as well
            const apiStatusEl = document.getElementById('api-status');
            if (apiStatusEl) {
                apiStatusEl.textContent = `é”™è¯¯: ${message.substring(0, 30)}...`; // Show a snippet of the error
                apiStatusEl.style.color = 'red';
            }
        }

        // New function to be called by Baidu Maps API callback
        function initializeMapAndCore() {
            console.log('Baidu Maps API loaded via callback. Initializing extensions and MapCore...');

            if (typeof BMap === 'undefined' || typeof BMap.Map === 'undefined') {
                console.error('BMap object not available in initializeMapAndCore.');
                showMapError('ç™¾åº¦åœ°å›¾APIæ ¸å¿ƒæœªèƒ½æ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                return;
            }

            const apiStatusEl = document.getElementById('api-status');
            if (apiStatusEl) {
                apiStatusEl.textContent = 'æ ¸å¿ƒå·²åŠ è½½, æ‰©å±•åŠ è½½ä¸­...';
                apiStatusEl.style.color = 'orange';
            }

            const protocol = window.location.protocol;
            let scriptsToLoad = 2; // TextIconOverlay and MarkerClusterer
            let scriptsLoaded = 0;

            function checkAllExtensionsLoaded() {
                scriptsLoaded++;
                if (scriptsLoaded === scriptsToLoad) {
                    console.log('All Baidu Map extensions loaded/attempted.');
                    if (apiStatusEl) {
                        apiStatusEl.textContent = 'æ ¸å¿ƒåŠæ‰©å±•å·²åŠ è½½';
                        apiStatusEl.style.color = 'green';
                    }
                    
                    if (window.MapCore && typeof window.MapCore.init === 'function') {
                        console.log('Initializing MapCore...');
                        window.MapCore.init().then(success => {
                            if (success) {
                                console.log('MapCore initialized successfully.');
                            } else {
                                console.error('MapCore initialization failed.');
                                showMapError('åœ°å›¾æ ¸å¿ƒåŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ã€‚');
                            }
                        }).catch(error => {
                            console.error('Error during MapCore initialization:', error);
                            showMapError('åœ°å›¾æ ¸å¿ƒåŠŸèƒ½åˆå§‹åŒ–æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                        });
                    } else {
                        console.error('MapCore or MapCore.init not found after extensions loaded.');
                        showMapError('åœ°å›¾æ ¸å¿ƒç»„ä»¶ä¸¢å¤±ï¼Œæ— æ³•åˆå§‹åŒ–åœ°å›¾ã€‚');
                    }
                }
            }

            // Load TextIconOverlay
            const textIconScript = document.createElement('script');
            textIconScript.type = 'text/javascript';
            textIconScript.src = `${protocol}//api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js`;
            textIconScript.onload = function() {
                console.log('TextIconOverlay library loaded successfully.');
                checkAllExtensionsLoaded();
            };
            textIconScript.onerror = function(e) {
                console.warn('TextIconOverlay library failed to load.', e);
                checkAllExtensionsLoaded(); // Proceed even if an extension fails
            };
            document.head.appendChild(textIconScript);

            // Load MarkerClusterer
            const clusterScript = document.createElement('script');
            clusterScript.type = 'text/javascript';
            clusterScript.src = `${protocol}//api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js`;
            clusterScript.onload = function() {
                console.log('MarkerClusterer library loaded successfully.');
                checkAllExtensionsLoaded();
            };
            clusterScript.onerror = function(e) {
                console.warn('MarkerClusterer library failed to load.', e);
                checkAllExtensionsLoaded(); // Proceed even if an extension fails
            };
            document.head.appendChild(clusterScript);
        }

        // Function to get encrypted AK from backend
        async function getBaiduMapAK() {
            try {
                // ä½¿ç”¨/api/map/config/ç«¯ç‚¹è·å–ç™¾åº¦åœ°å›¾AK
                const response = await fetch('/api/map/config/');
                if (response.ok) {
                    const data = await response.json();
                    return data.bmap_ak;
                } else {
                    console.error('è·å–ç™¾åº¦åœ°å›¾AKå¤±è´¥:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('è·å–ç™¾åº¦åœ°å›¾AKæ—¶å‘ç”Ÿé”™è¯¯:', error);
                // åç«¯APIä¸å¯ç”¨ï¼Œè¿”å›null
                return null;
            }
        }

        // Function to dynamically load Baidu Maps API
        async function loadBaiduMapsAPI() {
            if (typeof BMap !== 'undefined' && typeof BMap.Map !== 'undefined') {
                console.log('Baidu Maps API already loaded. Triggering initialization.');
                initializeMapAndCore(); // Call directly if BMap is already there
                return;
            }

            // ä»åç«¯è·å–åŠ å¯†çš„AK
            const apiStatusEl = document.getElementById('api-status');
            if (apiStatusEl) {
                apiStatusEl.textContent = 'è·å–APIå¯†é’¥ä¸­...';
                apiStatusEl.style.color = 'orange';
            }

            const ak = await getBaiduMapAK();
            if (!ak) {
                const errorMsg = 'æ— æ³•è·å–ç™¾åº¦åœ°å›¾AKï¼Œæ— æ³•åŠ è½½åœ°å›¾ã€‚';
                console.error(errorMsg);
                showMapError(errorMsg);
                return;
            }

            window.BMAP_AUTHENTIC_KEY = ak;
            
            const script = document.createElement('script');
            script.type = 'text/javascript';
            const protocol = window.location.protocol;
            // ä½¿ç”¨v3.0ç‰ˆæœ¬çš„ç™¾åº¦åœ°å›¾API
            script.src = `${protocol}//api.map.baidu.com/api?v=3.0&ak=${ak}&callback=initializeMapAndCore`;
            script.onerror = function(e) {
                const errorMsg = 'ç™¾åº¦åœ°å›¾APIä¸»è„šæœ¬åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œå’ŒAKã€‚';
                console.error(errorMsg, e);
                showMapError(errorMsg);
            };
            document.head.appendChild(script);
            console.log('Attempting to load Baidu Maps API v3.0 with callback...');
            if (apiStatusEl) {
                apiStatusEl.textContent = 'ä¸»è„šæœ¬åŠ è½½ä¸­...';
                apiStatusEl.style.color = 'orange';
            }
        }

        // Load Baidu Maps API when the DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            loadBaiduMapsAPI();
        });
    </script>
</head>
<body>
    <header>
        <div class="logo-container">
            <h1>é™•è¥¿éç‰©è´¨æ–‡åŒ–é—äº§ Â· æ°‘é—´æ–‡åŒ–å±•ç¤ºå¹³å°</h1>
        </div>
        <div class="header-right">
            <div class="search-icon">ğŸ”</div>
            <div class="message-icon">ğŸ’¬</div>
            <div class="refresh-icon">ğŸ”„</div>
            <div class="date" id="current-date">2025å¹´4æœˆ2æ—¥æ˜ŸæœŸä¸‰ 19:04</div>
            <div class="user-icon">ğŸ‘¤</div>
        </div>
    </header>
    
    <nav>
        <ul class="main-nav">
            <li><a href="../index.html">é¦–é¡µ</a></li>
            <li><a href="/pages/policy.html">ç›¸å…³æ”¿ç­–</a></li>
            <li><a href="/pages/news.html">éé—èµ„è®¯</a></li>
            <li><a href="non-heritage-list.html">éé—åå½•</a></li>
            <li><a href="forum.html">éé—è®ºå›</a></li>
            <li><a href="heritage-map.html" class="active">éé—åœ°å›¾</a></li>
            <li><a href="user-creation.html">ç”¨æˆ·åˆ›ä½œ</a></li>
            <li><a href="#">ä¼ æ‰¿äººé£é‡‡</a></li>
        </ul>
    </nav>
    
    <main class="map-main">
        <div class="map-container">
            <div class="map-sidebar">
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="map-level-filter">çº§åˆ«ç­›é€‰ï¼š</label>
                        <select id="map-level-filter">
                            <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                            <option value="å›½å®¶çº§">å›½å®¶çº§</option>
                            <option value="çœçº§">çœçº§</option>
                            <option value="å¸‚çº§">å¸‚çº§</option>
                            <option value="å¿çº§">å¿çº§</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="map-category-filter">ç±»åˆ«ç­›é€‰ï¼š</label>
                        <select id="map-category-filter">
                            <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                            <option value="ä¼ ç»Ÿæˆå‰§">ä¼ ç»Ÿæˆå‰§</option>
                            <option value="ä¼ ç»ŸéŸ³ä¹">ä¼ ç»ŸéŸ³ä¹</option>
                            <option value="ä¼ ç»ŸæŠ€è‰º">ä¼ ç»ŸæŠ€è‰º</option>
                            <option value="ä¼ ç»Ÿç¾æœ¯">ä¼ ç»Ÿç¾æœ¯</option>
                            <option value="ä¼ ç»Ÿèˆè¹ˆ">ä¼ ç»Ÿèˆè¹ˆ</option>
                            <option value="ä¼ ç»Ÿç¾é£Ÿ">ä¼ ç»Ÿç¾é£Ÿ</option>
                            <option value="æ°‘é—´æ–‡å­¦">æ°‘é—´æ–‡å­¦</option>
                            <option value="æ°‘ä¿—">æ°‘ä¿—</option>
                            <option value="æ›²è‰º">æ›²è‰º</option>
                        </select>
                    </div>
                </div>
                
                <div class="filtered-projects">
                    <h4>é¡¹ç›®æ¸…å•</h4>
                    <div class="project-list" id="filtered-project-list">
                        <div class="project-empty">è¯·é€‰æ‹©ç­›é€‰æ¡ä»¶</div>
                    </div>
                    <div class="project-count"></div>
                </div>
                
                <div class="heritage-preview" id="heritage-preview">
                    <h3>é¡¹ç›®é¢„è§ˆ</h3>
                    <div class="preview-content">
                        <p class="preview-placeholder">ç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°æŸ¥çœ‹éé—é¡¹ç›®è¯¦æƒ…</p>
                    </div>
                </div>
                
                <div class="map-refresh-container">
                <button id="refresh-map" class="map-refresh-btn">
                        åˆ·æ–°åœ°å›¾æ˜¾ç¤º
                    </button>
                </div>
            </div>
            
            <div id="baidu-map" class="map-view"></div>
        </div>
    </main>
    
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>è”ç³»æˆ‘ä»¬</h4>
                <p>åœ°å€ï¼šé™•è¥¿çœè¥¿å®‰å¸‚</p>
                <p>ç”µè¯ï¼šonee20589@gmail.com</p>
                <p>é‚®ç®±ï¼šonee20589@gmail.com</p>
            </div>
            <div class="footer-section">
                <h4>å…³æ³¨æˆ‘ä»¬</h4>
                <div class="social-icons">
                    <span>å¾®ä¿¡</span>
                    <span>å¾®åš</span>
                    <span>æŠ–éŸ³</span>
                </div>
            </div>
            <div class="footer-section">
                <h4>å‹æƒ…é“¾æ¥</h4>
                <p><a href="https://whhlyt.shaanxi.gov.cn/" target="_blank">é™•è¥¿çœæ–‡åŒ–æ—…æ¸¸å…</a></p>
                <p><a href="https://www.ihchina.cn/" target="_blank">ä¸­å›½éç‰©è´¨æ–‡åŒ–é—äº§ç½‘</a></p>
                <p><a href="#">é™•è¥¿æ–‡åŒ–å±•ç¤ºå¹³å°</a></p>
            </div>
        </div>
        <div class="copyright">
            <p>Â© 2025 é™•è¥¿éç‰©è´¨æ–‡åŒ–é—äº§å±•ç¤ºå¹³å° ç‰ˆæƒæ‰€æœ‰</p>
            <p>æœ¬ç½‘ç«™ä»…ç”¨äºå­¦ä¹ å’Œéå•†ä¸šç”¨é€”</p>
            <p>æŠ€æœ¯æ”¯æŒï¼šelaine</p>
        </div>
    </footer>

    <!-- å…¶ä»–ç¬¬ä¸‰æ–¹è„šæœ¬ -->
    <script src="../lib/third-party-embed.js" defer></script>
    <script src="../lib/maxkb_embed.js" defer></script>
    
    <!-- UIç»„ä»¶ -->
    <script src="../js/common/heritage-ui.js" defer></script>
    
    <!-- ç­›é€‰åŠŸèƒ½ -->
    <script src="../js/pages/heritage-filters.js" defer></script>
    
    <!-- åœ°å›¾æ ¸å¿ƒåŠŸèƒ½ -->
    <script src="/js/pages/heritage-map.js" defer></script>
    
    <!-- ä¾§è¾¹æ åŠŸèƒ½ -->
    <script src="/js/pages/heritage-map-sidebar.js" defer></script>
    
    <!-- åº”ç”¨åˆå§‹åŒ–è„šæœ¬ (é€»è¾‘å·²ç§»è‡³æ–°çš„åœ°å›¾åŠ è½½å›è°ƒä¸­) -->
    
    <!-- ç§»é™¤è°ƒè¯•ä¿¡æ¯æ  -->
    
    <script>
        // DOMContentLoaded ä¿è¯å…ƒç´ å·²æ¸²æŸ“å†æ“ä½œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ›´æ–°APIåè®®ä¿¡æ¯
            var protocolEl = document.getElementById('api-protocol');
            if(protocolEl) protocolEl.textContent = window.location.protocol;

            // API status is now updated by the map loading functions.

            // ä¸ºåˆ·æ–°æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            var refreshBtn = document.getElementById('refresh-map');
            if(refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    console.log('æ‰‹åŠ¨åˆ·æ–°åœ°å›¾æ˜¾ç¤º');
                    if (window.MapCore && typeof window.MapCore.refreshMap === 'function') {
                        window.MapCore.refreshMap();
                    }
                    if (window.HeritageFilters && typeof window.HeritageFilters.applyFilters === 'function') {
                        window.HeritageFilters.applyFilters(window.currentHeritageData || []);
                    }
                });
            }
        });
    </script>
</body>
</html>
